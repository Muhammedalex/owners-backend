# تقارير ورسوم بيانية - Reports & Charts

## نظرة عامة

هذا الدليل يشرح التقارير والرسوم البيانية المتاحة لكل ownership في النظام. جميع التقارير تعتمد على البيانات الخاصة بكل ownership فقط (ownership scope).

---

## 1. تقارير المستأجرين (Tenants Reports)

### 1.1 إحصائيات عامة
- **إجمالي المستأجرين**: عدد المستأجرين المسجلين في الملكية
- **المستأجرون النشطون**: عدد المستأجرين الذين لديهم عقود نشطة
- **المستأجرون الجدد**: عدد المستأجرين المضافين في فترة محددة

### 1.2 تقارير التقييمات (Ratings)
- **توزيع التقييمات**: 
  - ممتاز (Excellent)
  - جيد (Good)
  - متوسط (Fair)
  - ضعيف (Poor)
- **نسبة كل تقييم**: نسبة كل فئة من إجمالي المستأجرين
- **مخطط دائري (Pie Chart)**: لتوزيع التقييمات

### 1.3 تقارير التوظيف (Employment Status)
- **حالة التوظيف**:
  - موظف (Employed)
  - يعمل لحسابه الخاص (Self Employed)
  - عاطل عن العمل (Unemployed)
  - متقاعد (Retired)
  - طالب (Student)
- **مخطط شريطي (Bar Chart)**: لتوزيع حالات التوظيف
- **متوسط الدخل**: متوسط دخل المستأجرين

### 1.4 تقارير الهوية
- **نوع الهوية**: توزيع أنواع الهويات (هوية وطنية، إقامة، جواز سفر)
- **الهويات المنتهية**: عدد الهويات التي ستنتهي قريباً

---

## 2. تقارير العقود (Contracts Reports)

### 2.1 إحصائيات عامة
- **إجمالي العقود**: عدد جميع العقود في الملكية
- **العقود النشطة**: عدد العقود الحالية (status: active)
- **العقود المنتهية**: عدد العقود المنتهية (status: expired)
- **العقود المعلقة**: عدد العقود قيد المراجعة (status: pending/draft)

### 2.2 تقارير الحالة (Status Distribution)
- **توزيع حالات العقود**:
  - مسودة (Draft)
  - قيد المراجعة (Pending)
  - نشط (Active)
  - منتهي (Expired)
  - ملغي (Cancelled)
  - منتهي (Terminated)
- **مخطط دائري**: لتوزيع حالات العقود

### 2.3 تقارير مالية
- **إجمالي قيمة الإيجارات**: مجموع قيمة جميع العقود النشطة
- **متوسط قيمة الإيجار**: متوسط قيمة الإيجار الشهري
- **أعلى/أقل إيجار**: أعلى وأقل قيمة إيجار
- **إجمالي الضمانات**: مجموع قيمة جميع الضمانات

### 2.4 تقارير الضمانات (Deposits)
- **حالة الضمانات**:
  - معلق (Pending)
  - مدفوع (Paid)
  - مسترد (Refunded)
  - مصادرة (Forfeited)
- **قيمة الضمانات المعلقة**: إجمالي الضمانات غير المدفوعة
- **قيمة الضمانات المدفوعة**: إجمالي الضمانات المدفوعة

### 2.5 تقارير التكرار (Payment Frequency)
- **توزيع تكرار الدفع**:
  - شهري (Monthly)
  - ربع سنوي (Quarterly)
  - سنوي (Yearly)
  - أسبوعي (Weekly)
- **مخطط شريطي**: لتوزيع تكرار الدفع

### 2.6 تقارير Ejar
- **عقود مسجلة في إيجار**: عدد العقود التي لديها كود إيجار
- **عقود غير مسجلة**: عدد العقود بدون كود إيجار
- **نسبة التسجيل**: نسبة العقود المسجلة في إيجار

### 2.7 تقارير زمنية
- **العقود المنتهية قريباً**: العقود التي ستنتهي خلال 30/60/90 يوم
- **العقود الجديدة**: العقود الموقعة في فترة محددة
- **مخطط زمني (Timeline)**: توزيع العقود حسب تاريخ البداية/النهاية

---

## 3. تقارير الفواتير (Invoices Reports)

### 3.1 إحصائيات عامة
- **إجمالي الفواتير**: عدد جميع الفواتير
- **الفواتير المرسلة**: عدد الفواتير المرسلة (status: sent)
- **الفواتير المدفوعة**: عدد الفواتير المدفوعة (status: paid)
- **الفواتير المتأخرة**: عدد الفواتير المتأخرة (status: overdue)
- **الفواتير المسودة**: عدد الفواتير المسودة (status: draft)

### 3.2 تقارير الحالة (Status Distribution)
- **توزيع حالات الفواتير**:
  - مسودة (Draft)
  - مرسلة (Sent)
  - مدفوعة (Paid)
  - متأخرة (Overdue)
  - ملغاة (Cancelled)
- **مخطط دائري**: لتوزيع حالات الفواتير

### 3.3 تقارير مالية
- **إجمالي قيمة الفواتير**: مجموع قيمة جميع الفواتير
- **إجمالي الضرائب**: مجموع قيمة الضرائب (VAT)
- **إجمالي المبلغ الإجمالي**: مجموع المبالغ الإجمالية (بما فيها الضرائب)
- **متوسط قيمة الفاتورة**: متوسط قيمة الفاتورة الواحدة

### 3.4 تقارير الديون
- **إجمالي المديونيات**: مجموع قيمة الفواتير غير المدفوعة
- **الفواتير المتأخرة**: قيمة الفواتير التي تجاوزت تاريخ الاستحقاق
- **مخطط شريطي**: قيمة الديون حسب الفترة

### 3.5 تقارير زمنية
- **الإيرادات الشهرية**: إجمالي الإيرادات لكل شهر
- **الإيرادات الربع سنوية**: إجمالي الإيرادات لكل ربع سنة
- **الإيرادات السنوية**: إجمالي الإيرادات لكل سنة
- **مخطط خطي (Line Chart)**: تطور الإيرادات مع الوقت

### 3.6 تقارير الاستحقاق
- **الفواتير المستحقة هذا الشهر**: الفواتير التي تستحق الدفع في الشهر الحالي
- **الفواتير المستحقة الأسبوع القادم**: الفواتير التي تستحق خلال 7 أيام
- **الفواتير المستحقة الشهر القادم**: الفواتير التي تستحق خلال 30 يوم

### 3.7 تقارير الضرائب
- **إجمالي الضرائب**: مجموع قيمة الضرائب المضافة
- **متوسط نسبة الضريبة**: متوسط نسبة الضريبة (عادة 15% VAT)
- **توزيع الضرائب**: حسب الفترة الزمنية

---

## 4. تقارير المدفوعات (Payments Reports)

### 4.1 إحصائيات عامة
- **إجمالي المدفوعات**: عدد جميع المدفوعات
- **المدفوعات المكتملة**: عدد المدفوعات المدفوعة (status: paid)
- **المدفوعات المعلقة**: عدد المدفوعات المعلقة (status: pending)
- **المدفوعات غير المدفوعة**: عدد المدفوعات غير المدفوعة (status: unpaid)

### 4.2 تقارير الحالة (Status Distribution)
- **توزيع حالات المدفوعات**:
  - معلق (Pending)
  - مدفوع (Paid)
  - غير مدفوع (Unpaid)
- **مخطط دائري**: لتوزيع حالات المدفوعات

### 4.3 تقارير مالية
- **إجمالي المدفوعات**: مجموع قيمة جميع المدفوعات
- **متوسط قيمة الدفعة**: متوسط قيمة الدفعة الواحدة
- **أعلى/أقل دفعة**: أعلى وأقل قيمة دفعة

### 4.4 تقارير طرق الدفع (Payment Methods)
- **توزيع طرق الدفع**:
  - نقد (Cash)
  - تحويل بنكي (Bank Transfer)
  - شيك (Check)
  - أخرى (Other)
- **مخطط دائري**: لتوزيع طرق الدفع
- **قيمة كل طريقة**: إجمالي المدفوعات لكل طريقة

### 4.5 تقارير زمنية
- **المدفوعات الشهرية**: إجمالي المدفوعات لكل شهر
- **المدفوعات اليومية**: إجمالي المدفوعات لكل يوم
- **مخطط خطي**: تطور المدفوعات مع الوقت
- **مخطط عمودي (Column Chart)**: المدفوعات حسب الشهر

### 4.6 تقارير الأداء
- **معدل التحصيل**: نسبة المدفوعات من إجمالي الفواتير
- **متوسط وقت التحصيل**: متوسط الوقت بين إصدار الفاتورة والدفع
- **المدفوعات المتأخرة**: المدفوعات التي تمت بعد تاريخ الاستحقاق

---

## 5. تقارير شاملة (Comprehensive Reports)

### 5.1 لوحة المعلومات الرئيسية (Dashboard)
- **نظرة عامة سريعة**:
  - عدد المستأجرين النشطين
  - عدد العقود النشطة
  - إجمالي الإيرادات الشهرية
  - إجمالي المدفوعات الشهرية
  - نسبة التحصيل
  - الفواتير المتأخرة

### 5.2 تقارير الأداء المالي
- **الإيرادات مقابل المصروفات**: مقارنة الإيرادات والمصروفات
- **نمو الإيرادات**: معدل نمو الإيرادات الشهرية/السنوية
- **التدفق النقدي**: تدفق الأموال الداخلة والخارجة
- **مخطط مزدوج (Dual Axis Chart)**: الإيرادات والمدفوعات معاً

### 5.3 تقارير الاستحقاق
- **جدول الاستحقاق**: جدول بجميع الفواتير المستحقة
- **الاستحقاق القادم**: الفواتير المستحقة في الأيام/الأسابيع القادمة
- **مخطط Gantt**: جدول زمني للاستحقاقات

### 5.4 تقارير المستأجرين المميزين
- **أفضل المستأجرين**: المستأجرين الأكثر دفعاً في الوقت المحدد
- **المستأجرين المتأخرين**: المستأجرين الذين لديهم فواتير متأخرة
- **المستأجرين طويل الأمد**: المستأجرين الذين لديهم عقود طويلة الأمد

---

## 6. أنواع الرسوم البيانية المقترحة

### 6.1 المخططات الدائرية (Pie Charts)
- توزيع التقييمات
- توزيع حالات العقود
- توزيع حالات الفواتير
- توزيع طرق الدفع

### 6.2 المخططات الشريطية (Bar Charts)
- توزيع حالات التوظيف
- توزيع تكرار الدفع
- الإيرادات الشهرية
- المدفوعات الشهرية

### 6.3 المخططات الخطية (Line Charts)
- تطور الإيرادات مع الوقت
- تطور المدفوعات مع الوقت
- نمو عدد المستأجرين
- نمو عدد العقود

### 6.4 المخططات العمودية (Column Charts)
- الإيرادات حسب الشهر
- المدفوعات حسب الشهر
- عدد الفواتير حسب الحالة
- عدد العقود حسب الحالة

### 6.5 المخططات المزدوجة (Dual Axis Charts)
- الإيرادات مقابل المدفوعات
- الفواتير المرسلة مقابل المدفوعة
- العقود النشطة مقابل المنتهية

### 6.6 الجداول التفاعلية (Data Tables)
- قائمة المستأجرين
- قائمة العقود
- قائمة الفواتير
- قائمة المدفوعات

---

## 7. نقاط مهمة

### 7.1 نطاق البيانات (Data Scope)
- **جميع التقارير تعتمد على ownership scope**: كل ownership يرى تقاريره فقط
- **Super Admin**: يمكنه رؤية تقارير جميع الملكيات
- **Regular Users**: يرون تقارير الملكيات التي لديهم access إليها فقط

### 7.2 الفلاتر (Filters)
- **الفترة الزمنية**: اختيار فترة محددة (يوم، أسبوع، شهر، ربع سنة، سنة)
- **الحالة**: فلترة حسب الحالة (active, paid, overdue, etc.)
- **النوع**: فلترة حسب النوع (contract type, payment method, etc.)
- **التاريخ**: فلترة حسب تاريخ البداية/النهاية

### 7.3 التصدير (Export)
- **PDF**: تصدير التقارير كملفات PDF
- **Excel**: تصدير البيانات كملفات Excel
- **CSV**: تصدير البيانات كملفات CSV

### 7.4 التحديث (Refresh)
- **تحديث تلقائي**: تحديث البيانات كل فترة محددة
- **تحديث يدوي**: إمكانية تحديث البيانات يدوياً
- **Cache**: تخزين مؤقت للبيانات لتحسين الأداء

---

## 8. API Endpoints المتاحة

### 8.1 Dashboard
```
GET /api/v1/reports/dashboard
```
**Query Parameters:**
- `start_date` (optional): تاريخ البداية (Y-m-d)
- `end_date` (optional): تاريخ النهاية (Y-m-d)

**Response:** نظرة عامة شاملة لجميع البيانات

---

### 8.2 Tenants Reports
```
GET /api/v1/reports/tenants/summary
GET /api/v1/reports/tenants/ratings
GET /api/v1/reports/tenants/employment
GET /api/v1/reports/tenants/top?limit=10
```

**Query Parameters:**
- `limit` (optional): عدد المستأجرين المطلوبين (default: 10, max: 100)

---

### 8.3 Contracts Reports
```
GET /api/v1/reports/contracts/summary
GET /api/v1/reports/contracts/status
GET /api/v1/reports/contracts/financial
GET /api/v1/reports/contracts/expiring?days=30
```

**Query Parameters:**
- `days` (optional): عدد الأيام للبحث عن العقود المنتهية (default: 30, max: 365)

---

### 8.4 Invoices Reports
```
GET /api/v1/reports/invoices/summary?start_date=2025-01-01&end_date=2025-12-31
GET /api/v1/reports/invoices/status?start_date=2025-01-01&end_date=2025-12-31
GET /api/v1/reports/invoices/overdue
```

**Query Parameters:**
- `start_date` (optional): تاريخ البداية (Y-m-d)
- `end_date` (optional): تاريخ النهاية (Y-m-d)

---

### 8.5 Revenue Reports
```
GET /api/v1/reports/revenue/monthly?months=12
GET /api/v1/reports/revenue/period?period=monthly&count=12
```

**Query Parameters:**
- `months` (optional): عدد الأشهر (default: 12, max: 24)
- `period` (optional): نوع الفترة (daily, weekly, monthly) - default: monthly
- `count` (optional): عدد الفترات (default: 12, max: 365)

---

### 8.6 Payments Reports
```
GET /api/v1/reports/payments/summary?start_date=2025-01-01&end_date=2025-12-31
GET /api/v1/reports/payments/methods?start_date=2025-01-01&end_date=2025-12-31
```

**Query Parameters:**
- `start_date` (optional): تاريخ البداية (Y-m-d)
- `end_date` (optional): تاريخ النهاية (Y-m-d)

---

### 8.7 Cache Management
```
POST /api/v1/reports/cache/clear
```

**Description:** مسح cache التقارير للملكية الحالية

---

## 9. أمثلة على الاستخدام

### 9.1 لوحة المعلومات الرئيسية
**Request:**
```
GET /api/v1/reports/dashboard?start_date=2025-01-01&end_date=2025-12-31
```

**Response:**
```json
{
  "success": true,
  "data": {
    "tenants": {
      "total": 25,
      "active": 20,
      "new_this_month": 3,
      "ratings": {
        "excellent": 8,
        "good": 12,
        "fair": 4,
        "poor": 1
      }
    },
    "contracts": {
      "total": 20,
      "active": 18,
      "expiring_soon": 2,
      "status": {
        "draft": 1,
        "pending": 0,
        "active": 18,
        "expired": 1,
        "terminated": 0,
        "cancelled": 0
      },
      "total_rent": 150000.00,
      "total_deposits": 300000.00
    },
    "invoices": {
      "total": 150,
      "status": {
        "draft": 5,
        "sent": 20,
        "paid": 120,
        "overdue": 5,
        "cancelled": 0
      },
      "amounts": {
        "total_amount": 750000.00,
        "total_tax": 112500.00,
        "total_total": 862500.00,
        "overdue_amount": 25000.00
      },
      "overdue": 5
    },
    "payments": {
      "total": 120,
      "status": {
        "pending": 5,
        "paid": 110,
        "unpaid": 5
      },
      "total_amount": 850000.00,
      "methods": {
        "cash": {
          "count": 20,
          "amount": 150000.00
        },
        "bank_transfer": {
          "count": 80,
          "amount": 650000.00
        },
        "check": {
          "count": 15,
          "amount": 40000.00
        },
        "other": {
          "count": 5,
          "amount": 10000.00
        }
      }
    },
    "revenue": {
      "this_month": 50000.00,
      "last_month": 48000.00,
      "growth": 4.17,
      "period_revenue": 850000.00
    },
    "performance": {
      "collection_rate": 80.00,
      "collection_rate_by_amount": 85.50,
      "total_invoices": 150,
      "paid_invoices": 120
    }
  }
}
```

### 9.2 تقرير الإيرادات الشهرية
**Request:**
```
GET /api/v1/reports/revenue/monthly?months=12
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "month": "2025-01",
      "month_name": "January 2025",
      "revenue": 45000.00,
      "payments": 42000.00
    },
    {
      "month": "2025-02",
      "month_name": "February 2025",
      "revenue": 48000.00,
      "payments": 46000.00
    },
    {
      "month": "2025-03",
      "month_name": "March 2025",
      "revenue": 50000.00,
      "payments": 48000.00
    }
  ]
}
```

### 9.3 تقرير توزيع التقييمات
**Request:**
```
GET /api/v1/reports/tenants/ratings
```

**Response:**
```json
{
  "success": true,
  "data": {
    "excellent": {
      "count": 8,
      "percentage": 32.00
    },
    "good": {
      "count": 12,
      "percentage": 48.00
    },
    "fair": {
      "count": 4,
      "percentage": 16.00
    },
    "poor": {
      "count": 1,
      "percentage": 4.00
    },
    "total": 25
  }
}
```

### 9.4 تقرير العقود المنتهية قريباً
**Request:**
```
GET /api/v1/reports/contracts/expiring?days=30
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "number": "CNT-001-2025-0001",
      "tenant_name": "Ahmed Ali",
      "unit_number": "0101",
      "end_date": "2025-12-15",
      "days_remaining": 5,
      "rent": 5000.00
    }
  ]
}
```

### 9.5 تقرير الفواتير المتأخرة
**Request:**
```
GET /api/v1/reports/invoices/overdue
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "number": "INV-001-2025-0001",
      "tenant_name": "Ahmed Ali",
      "unit_number": "0101",
      "due_date": "2025-11-15",
      "days_overdue": 25,
      "total": 5750.00,
      "amount": 5000.00
    }
  ]
}
```

### 9.6 تقرير أفضل المستأجرين
**Request:**
```
GET /api/v1/reports/tenants/top?limit=10
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "tenant_id": 1,
      "tenant_name": "Ahmed Ali",
      "rating": "excellent",
      "total_invoices": 12,
      "paid_invoices": 12,
      "payment_rate": 100.00,
      "on_time_rate": 95.00,
      "total_paid": 69000.00
    }
  ]
}
```

---

## 10. المميزات المتقدمة

### 10.1 Caching (التخزين المؤقت)
- **مدة Cache**: 5 دقائق (قابلة للتعديل)
- **Cache Keys**: فريدة لكل ownership وفترة زمنية
- **Auto Refresh**: تحديث تلقائي عند انتهاء مدة Cache
- **Manual Clear**: إمكانية مسح Cache يدوياً

### 10.2 Performance (الأداء)
- **Query Optimization**: استخدام indexes و eager loading
- **Aggregation**: استخدام DB aggregations بدلاً من PHP loops
- **Lazy Loading**: تحميل البيانات عند الحاجة فقط
- **Batch Processing**: معالجة البيانات بشكل مجمع

### 10.3 Advanced Filtering (الفلاتر المتقدمة)
- **Date Ranges**: فلترة حسب فترات زمنية مرنة
- **Multiple Filters**: دعم عدة فلاتر في نفس الوقت
- **Dynamic Periods**: فترات ديناميكية (daily, weekly, monthly)
- **Custom Ranges**: فترات مخصصة حسب التاريخ

### 10.4 Data Aggregation (تجميع البيانات)
- **Grouping**: تجميع البيانات حسب معايير مختلفة
- **Calculations**: حسابات معقدة (متوسطات، نسب، إجماليات)
- **Percentages**: حساب النسب المئوية تلقائياً
- **Growth Rates**: حساب معدلات النمو

### 10.5 Security (الأمان)
- **Ownership Scope**: جميع التقارير محمية بـ ownership scope
- **Authorization**: التحقق من الصلاحيات في كل endpoint
- **Data Isolation**: عزل البيانات بين الملكيات
- **Rate Limiting**: حماية من الإساءة

### 10.6 Error Handling (معالجة الأخطاء)
- **Validation**: التحقق من صحة المدخلات
- **Error Messages**: رسائل خطأ واضحة
- **Fallback Values**: قيم افتراضية عند عدم وجود بيانات
- **Logging**: تسجيل الأخطاء للتحليل

---

## 11. الخطوات التالية

1. **إنشاء Controllers** للتقارير
2. **إنشاء Services** لحساب البيانات
3. **إنشاء Resources** لتنسيق البيانات
4. **إضافة Caching** لتحسين الأداء
5. **إنشاء Tests** للتحقق من صحة البيانات

---

**ملاحظة**: جميع التقارير تعتمد على البيانات الموجودة في قاعدة البيانات وتتبع نفس قواعد ownership scope المطبقة في باقي النظام.


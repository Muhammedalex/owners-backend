# وحدات الفواتير والمدفوعات - الشرح بالعربية

## نظرة عامة

هذا المستند يشرح كيفية عمل وحدات **الفواتير (Invoices)** و **المدفوعات (Payments)** في نظام إدارة الملكيات.

---

## وحدة الفواتير (Invoices Module)

### ما هي الفواتير؟

الفواتير هي مستندات فواتير يتم إنشاؤها **عند الطلب (On-Demand)** لتسجيل المبالغ المستحقة على المستأجرين بناءً على عقود الإيجار.

### المميزات الرئيسية:

#### 1. **إنشاء الفواتير عند الطلب (Optional/On-Demand)**
- ✅ الفواتير **ليست إلزامية** - يمكن أن توجد عقود بدون فواتير
- ✅ الفواتير **لا يتم إنشاؤها تلقائياً** - يتم إنشاؤها فقط عند طلب المستخدم
- ✅ يمكن إنشاء فواتير لـ **فترات محددة** حسب الحاجة
- ✅ يمكن إنشاء فواتير **يدوياً** من خلال واجهة المستخدم

#### 2. **ربط الفواتير بالعقود**
- كل فاتورة مرتبطة بعقد إيجار محدد
- الفاتورة تستمد بياناتها من العقد (المستأجر، الوحدة، قيمة الإيجار)
- يمكن إنشاء عدة فواتير لنفس العقد لفترات مختلفة

#### 3. **حساب الضريبة (VAT)**
- النظام يحسب ضريبة القيمة المضافة تلقائياً
- **نسبة الضريبة الافتراضية: 15%** (ضريبة القيمة المضافة السعودية)
- **المبلغ الإجمالي = المبلغ الأساسي + الضريبة**

#### 4. **عناصر الفاتورة (Invoice Items)**
- كل فاتورة تحتوي على **عناصر متعددة** (Line Items)
- أنواع العناصر:
  - **إيجار** (Rent)
  - **خدمات** (Utilities)
  - **صيانة** (Maintenance)
  - **غرامات** (Penalties)
  - **أخرى** (Other)
- كل عنصر له: الوصف، الكمية، سعر الوحدة، الإجمالي

#### 5. **حالات الفاتورة (Status)**
- **مسودة (Draft)** - يمكن التعديل
- **مرسلة (Sent)** - تم إرسالها للمستأجر
- **مدفوعة (Paid)** - تم دفعها
- **متأخرة (Overdue)** - تجاوزت تاريخ الاستحقاق
- **ملغاة (Cancelled)** - تم إلغاؤها

#### 6. **فترات الفوترة**
- **تاريخ البداية (Period Start)** - بداية فترة الفوترة
- **تاريخ النهاية (Period End)** - نهاية فترة الفوترة
- **تاريخ الاستحقاق (Due Date)** - آخر موعد للدفع

### كيف تعمل الفواتير؟

#### عملية إنشاء الفاتورة:

1. **المستخدم يطلب إنشاء فاتورة**
   - يختار العقد
   - يحدد فترة الفوترة (تاريخ البداية والنهاية)
   - يحدد تاريخ الاستحقاق

2. **النظام يحسب المبلغ**
   - يأخذ قيمة الإيجار من العقد
   - يضيف أي عناصر إضافية (خدمات، صيانة، إلخ)
   - يحسب الضريبة (15%)
   - يحسب الإجمالي

3. **إنشاء رقم الفاتورة**
   - رقم فريد لكل فاتورة
   - يمكن أن يكون تلقائي أو يدوي

4. **حفظ الفاتورة**
   - يتم حفظ الفاتورة بحالة "مسودة"
   - يمكن التعديل قبل الإرسال

5. **إرسال الفاتورة**
   - تغيير الحالة إلى "مرسلة"
   - يمكن إرسالها عبر البريد الإلكتروني أو طباعتها

---

## وحدة المدفوعات (Payments Module)

### ما هي المدفوعات؟

المدفوعات هي **سجلات فقط** لتسجيل حالة الدفع. **جميع المدفوعات الفعلية تتم خارج النظام**.

### المميزات الرئيسية:

#### 1. **تسجيل الحالة فقط (Status Recording Only)**
- ✅ **لا يوجد معالجة دفع إلكتروني** - جميع المدفوعات تتم خارج النظام
- ✅ **لا يوجد تكامل مع بوابات الدفع** - النظام لا يتعامل مع البنوك أو البوابات
- ✅ النظام **يسجل فقط** هل تم الدفع أم لا
- ✅ المستخدم يدخل حالة الدفع **يدوياً** بعد استلام المبلغ

#### 2. **ربط المدفوعات بالفواتير**
- كل دفعة مرتبطة بفاتورة محددة
- يمكن دفع الفاتورة كاملة أو جزئياً
- يمكن ربط عدة دفعات بفاتورة واحدة (دفعات متعددة)

#### 3. **طرق الدفع (Payment Methods)**
- **نقد (Cash)**
- **تحويل بنكي (Bank Transfer)**
- **شيك (Check)**
- **أخرى (Other)**
- **ملاحظة:** هذه فقط للتوثيق - لا يوجد معالجة فعلية

#### 4. **حالات الدفع (Payment Status)**
- **مدفوع (Paid)** - تم استلام المبلغ
- **غير مدفوع (Unpaid)** - لم يتم الدفع
- **معلق (Pending)** - في الانتظار

#### 5. **تأكيد الدفع**
- **المستخدم المصرح له** يؤكد استلام الدفع
- يتم تسجيل **من قام بالتأكيد** و **متى**
- يمكن تعديل حالة الدفع إذا تم تسجيلها خطأ

### كيف تعمل المدفوعات؟

#### عملية تسجيل الدفع:

1. **استلام المبلغ خارج النظام**
   - المستأجر يدفع المبلغ (نقد، تحويل، شيك)
   - المالك/الموظف يستلم المبلغ

2. **تسجيل الدفع في النظام**
   - المستخدم المصرح له يدخل النظام
   - يختار الفاتورة
   - يسجل: المبلغ، طريقة الدفع، تاريخ الدفع
   - يضغط "تأكيد الدفع"

3. **تحديث حالة الفاتورة**
   - النظام يغير حالة الفاتورة إلى "مدفوعة"
   - يتم حفظ سجل الدفع

4. **التاريخ والسجلات**
   - يتم حفظ تاريخ الدفع
   - يتم حفظ من قام بالتأكيد
   - يمكن الرجوع للسجلات لاحقاً

---

## العلاقة بين الفواتير والمدفوعات

### التدفق الكامل:

```
عقد إيجار (Contract)
    ↓
إنشاء فاتورة عند الطلب (Invoice - Optional)
    ↓
إرسال الفاتورة للمستأجر
    ↓
المستأجر يدفع خارج النظام (Cash/Bank Transfer/Check)
    ↓
تسجيل الدفع في النظام (Payment Record)
    ↓
تحديث حالة الفاتورة إلى "مدفوعة"
```

### أمثلة على الاستخدام:

#### مثال 1: فاتورة شهرية عادية
1. عقد إيجار بقيمة 5000 ريال شهرياً
2. في نهاية الشهر، المالك يطلب إنشاء فاتورة
3. النظام ينشئ فاتورة:
   - الإيجار: 5000 ريال
   - الضريبة (15%): 750 ريال
   - الإجمالي: 5750 ريال
4. يتم إرسال الفاتورة للمستأجر
5. المستأجر يدفع 5750 ريال نقداً
6. المالك يسجل الدفع في النظام
7. الفاتورة تصبح "مدفوعة"

#### مثال 2: فاتورة مع عناصر إضافية
1. عقد إيجار بقيمة 5000 ريال
2. المالك يطلب إنشاء فاتورة مع خدمات إضافية
3. النظام ينشئ فاتورة:
   - الإيجار: 5000 ريال
   - الكهرباء: 300 ريال
   - المياه: 150 ريال
   - الضريبة (15%): 817.5 ريال
   - الإجمالي: 6267.5 ريال
4. المستأجر يدفع المبلغ
5. يتم تسجيل الدفع

#### مثال 3: دفع جزئي
1. فاتورة بقيمة 5750 ريال
2. المستأجر يدفع 3000 ريال أولاً
3. يتم تسجيل دفعة جزئية (3000 ريال)
4. لاحقاً يدفع الباقي (2750 ريال)
5. يتم تسجيل دفعة ثانية
6. الفاتورة تصبح "مدفوعة بالكامل"

---

## المميزات الإضافية

### 1. **تتبع المدفوعات للمستأجرين (Optional)**
- يمكن تفعيل/تعطيل خاصية تتبع المدفوعات
- تساعد في مراقبة سلوك المستأجر في الدفع
- تتبع المدفوعات المتأخرة
- تقييم التزام المستأجر بالدفع

### 2. **التقارير**
- تقرير الفواتير المرسلة
- تقرير الفواتير المدفوعة
- تقرير الفواتير المتأخرة
- تقرير المدفوعات المستلمة

### 3. **التذكيرات**
- تذكير بالفواتير المستحقة
- تذكير بالفواتير المتأخرة
- إشعارات للمستأجرين

---

## ملاحظات مهمة

### ⚠️ ما لا يفعله النظام:

1. **لا يقوم بمعالجة الدفع الإلكتروني**
   - لا يوجد تكامل مع البنوك
   - لا يوجد تكامل مع بوابات الدفع (مثل PayPal, Stripe)
   - لا يوجد معالجة بطاقات الائتمان

2. **لا ينشئ الفواتير تلقائياً**
   - الفواتير يتم إنشاؤها فقط عند الطلب
   - لا يوجد جدولة تلقائية للفواتير

3. **لا يرسل المدفوعات**
   - النظام لا يرسل أموال
   - جميع المدفوعات تتم خارج النظام

### ✅ ما يفعله النظام:

1. **يسجل الفواتير**
   - إنشاء فواتير عند الطلب
   - حساب الضرائب تلقائياً
   - حفظ سجلات الفواتير

2. **يسجل المدفوعات**
   - تسجيل حالة الدفع (مدفوع/غير مدفوع)
   - حفظ تاريخ الدفع
   - حفظ طريقة الدفع (للتوثيق)

3. **يوفر التقارير**
   - تقارير الفواتير
   - تقارير المدفوعات
   - إحصائيات مالية

---

## الخلاصة

- **الفواتير**: مستندات فواتير يتم إنشاؤها عند الطلب، مرتبطة بالعقود، مع حساب ضريبي تلقائي
- **المدفوعات**: سجلات فقط لتوثيق حالة الدفع، جميع المدفوعات الفعلية تتم خارج النظام
- **العلاقة**: الفواتير → المدفوعات → تحديث حالة الفاتورة
- **الهدف**: توثيق وتسجيل العمليات المالية، وليس معالجة الدفع الإلكتروني


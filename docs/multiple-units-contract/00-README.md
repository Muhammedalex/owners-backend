## Multiple Units per Contract - Documentation (بعد التنفيذ)

هذه الوثيقة مخصّصة لتوثيق **التنفيذ الفعلي** لميزة:  
**"Multiple Units per Contract"** – عقد واحد يحتوي على عدة وحدات لنفس المستأجر.

المستند المرجعي للتحليل والمتطلبات موجود في:
- `docs/new-features/02-multiple-units-contract.md`

---

## 1. نظرة عامة بعد التنفيذ

- **الحالة**: _يتم التحديث بعد إكمال التطوير_
- **الوحدات المتأثرة**:
  - العقود (Contracts)
  - الوحدات (Units)
  - الفواتير (Invoices)
  - المدفوعات (Payments) – إن وُجد تأثير مباشر

اكتب هنا ملخصًا نهائيًا لكيفية عمل الميزة فعليًا في النظام بعد الإطلاق.

---

## 2. التغييرات على قاعدة البيانات (Database Changes)

اشرح هنا ما تم تنفيذه فعليًا (وليس المخطّط فقط):

- الجداول الجديدة (إن وُجدت) مثل:
  - `contract_units` (علاقة عقد ← وحدات)
- الأعمدة المضافة/المعدّلة في:
  - `contracts`
  - `units`
  - جداول أخرى متأثرة

لكل جدول/عمود:
- الاسم
- النوع
- القيود (FK, Index, Unique, …)
- ملاحظات عملية (مثال: كيف يؤثر على الاستعلامات/الأداء)

---

## 3. التغييرات على الـ API

وثّق هنا النقاط التالية:

- **نقاط النهاية المحدثة**:
  - `POST /api/v1/contracts` – كيف نستقبل قائمة الوحدات؟
  - `GET /api/v1/contracts/{id}` – كيف نعرض الوحدات المرتبطة؟
  - أي Endpoints أخرى تأثرت.

- **نماذج الطلب/الاستجابة (Request/Response Examples)**:
  - أمثلة JSON لعقد يحتوي على عدة وحدات.
  - كيف يتم تمثيل الوحدات داخل العقد في الـ API Resource.

- **قواعد التحقق (Validation Rules)**:
  - التحقق من أن:
    - جميع الوحدات من نفس الملكية.
    - لا توجد وحدة لديها عقد نشط آخر.

---

## 4. منطق العمل (Business Logic & Workflow)

### 4.1 إنشاء عقد يحتوي على عدة وحدات
- خطوات فعلية في النظام (Owner → Contracts → Create …).
- نقاط التحقق (Validation) التي تم تنفيذها في الـ Service/Request.

### 4.2 عرض العقد مع الوحدات
- ما الذي يظهر في واجهة المالك/المستأجر؟
- كيف يتم حساب:
  - الإيجار الكلي.
  - إيجار كل وحدة (إن وُجد).

### 4.3 إلغاء/إنهاء العقد
- ماذا يحدث للوحدات المرتبطة عند:
  - إنهاء العقد.
  - تجديد العقد.

---

## 5. الربط مع الفواتير والمدفوعات

إذا كان العقد المتعدد الوحدات يؤثر على:
- توليد الفواتير (Invoice Generation)
- توزيع المبالغ على الوحدات
- تتبع المدفوعات

فوثّق هنا:
- كيف يتم حساب مبلغ الفاتورة.
- هل يتم تخزين تفاصيل الوحدات داخل الفاتورة أم يتم الاعتماد على العقد فقط.

---

## 6. القيود والحالات الخاصة (Edge Cases & Limitations)

اذكر هنا أي قيود عملية تم اعتمادها في التنفيذ، مثل:
- الحد الأقصى لعدد الوحدات في العقد.
- ماذا يحدث إذا تم حذف وحدة/إلغاء تفعيلها وهي مرتبطة بعقد نشط.
- أي قرارات تصميم تم اتخاذها لتبسيط التنفيذ.

---

## 7. الاختبارات (Testing Checklist)

قائمة تحقق يمكن استخدامها لـ QA:

- **إنشاء عقد**:
  - عقد بوحدة واحدة.
  - عقد بعدة وحدات لنفس المالك والملكية.
  - محاولة إضافة وحدة من ملكية مختلفة (يجب أن تفشل).
  - محاولة إضافة وحدة لديها عقد نشط (يجب أن تفشل).

- **عرض العقد**:
  - التأكد من ظهور جميع الوحدات.
  - التأكد من صحة الأرقام (الإيجار الكلي، عدد الوحدات، إلخ).

- **تعديل العقد** (إن كان مسموحًا):
  - إضافة وحدة جديدة لعقد قائم.
  - إزالة وحدة من عقد قائم.

- **إنهاء العقد**:
  - التأكد من إعادة تعيين حالة الوحدات إلى متاحة (Available).

استخدم هذه الصفحة كتوثيق نهائي بعد التنفيذ، وحدّثها كلما تم تعديل المنطق المتعلق بالعقود متعددة الوحدات.


